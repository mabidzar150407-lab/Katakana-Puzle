<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Puzzle Katakana ‚Äî Final (UI A)</title>
<style>
:root{
  --bg: #ffeef5;
  --card-front: #4d7cff;
  --card-back: #ffdd9c;
  --accent: #ff66a3;
  --muted: #888;
  --slot-border: #b8b8b8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter, Arial, sans-serif;-webkit-font-smoothing:antialiased}
.app{min-height:100%;display:flex;flex-direction:column}
header{padding:12px 16px;text-align:center}
header h1{margin:0;color:#cc3366;font-size:20px}
main{flex:1 1 auto;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:12px}
.info-area{height:36px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#555;width:100%;max-width:540px}
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%;max-width:540px}
.slot{width:80px;height:80px;background:#fff;border:2px dashed var(--slot-border);border-radius:12px;display:flex;align-items:center;justify-content:center;transition:0.18s;flex:0 0 auto}
.slot:hover{border-color:#7aa7ff;transform:translateY(-3px)}
/* Card / flip */
.card{
  width:76px;height:76px;cursor:grab;
  position:relative;perspective:900px;
  touch-action:none;
  user-select:none;
}
.card-inner{
  width:100%;height:100%;position:absolute;left:0;top:0;
  transform-style:preserve-3d;transition:transform .36s cubic-bezier(.2,.9,.2,1);
}
.card.flipped .card-inner{transform:rotateY(180deg)}
.front,.back{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  border-radius:10px;font-weight:700;backface-visibility:hidden;
}
.front{background:var(--card-front);color:#fff;font-size:34px}
.back{background:var(--card-back);color:#111;transform:rotateY(180deg);font-size:22px}
.card.dragging{transition:none!important;box-shadow:0 18px 34px rgba(0,0,0,0.16)}
.slot-placeholder{background:transparent;border-radius:10px}
#result{text-align:center;font-size:20px;height:28px;color:#2b7a2b;font-weight:700}
#reveal-container{display:grid;grid-template-columns:repeat(2,1fr);width:220px;height:220px;gap:0;margin-top:6px}
.reveal-box{width:100%;height:100%;border-radius:10px;background-image:url("img/question.png");background-size:200% 200%;background-repeat:no-repeat;transform-style:preserve-3d;transition:transform .35s ease}
.reveal-box.revealed{transform:rotateY(180deg)}
.bottom-bar{display:flex;gap:12px;justify-content:center;align-items:center;padding:12px;background:rgba(255,255,255,0.12);border-top:1px solid rgba(0,0,0,0.05)}
.btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:var(--muted)}
/* responsiveness */
@media(max-width:480px){
  header h1{font-size:18px}
  .slot{width:60px;height:60px}
  .card{width:56px;height:56px}
  .front{font-size:22px}
  .back{font-size:16px}
  #reveal-container{width:160px;height:160px}
  .slot-placeholder{width:56px;height:56px}
}

/* === FIX UTAMA: pastikan kartu tidak terpotong & flip tidak mengganggu drag === */

/* kartu tidak terpotong */
.card {
  transform-style: preserve-3d;
  backface-visibility: hidden;
  overflow: visible !important;
}


/* inner tetap 3D agar flip normal */
.card-inner {
  transform-style: preserve-3d;
  backface-visibility: hidden;
}

/* Tombol suara */
.sound-btn {
  margin-left: 10px;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  background: #ff66a3;
  color: white;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.2s;
}

.sound-btn:hover {
  background: #ff338a;
  transform: scale(1.1);
}

.sound-btn:active {
  transform: scale(0.9);
}


</style>
</head>
<body>
  <div class="app">
    <header><h1>Puzzle Katakana</h1></header>
    <main>
      <div class="row" id="topRow"></div>
<div id="headerRow" class="info-area">
    <span id="mainInstruction">Susun huruf katakana di bawah</span>

    <!-- Tombol suara -->
    <button id="soundBtn" class="sound-btn">üîä</button>
    <button id="soundSlow" class="sound-btn slow">üê¢</button>
</div>
      <div class="row" id="bottomRow"></div>
      <div id="result"></div>
      <div id="reveal-container" aria-hidden="false">
        <div class="reveal-box"></div><div class="reveal-box"></div><div class="reveal-box"></div><div class="reveal-box"></div>
      </div>
    </main>
    <div class="bottom-bar">
      <button id="backBtn" class="btn secondary">‚¨Ö KEMBALI</button>
      <div id="levelText">Level 1</div>
      <button id="nextBtn" class="btn">NEXT ‚ûú</button>
    </div>
  </div>

<script>

document.addEventListener("DOMContentLoaded", () => {
    initSoundButtons();
});


/* ---------------- Data ---------------- */
const wordList=["„ÉÜ„É¨„Éì","„Ç≥„É≥„Éî„É•„Éº„Çø„Éº","„Éê„Çπ","„Éë„É≥","„Ç≥„Éº„Éí„Éº","„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†","„Çø„ÇØ„Ç∑„Éº","„Éõ„ÉÜ„É´","„É¨„Çπ„Éà„É©„É≥","„Çπ„Éû„Éõ","„Éì„Éá„Ç™","„ÉÅ„Éß„Ç≥„É¨„Éº„Éà","„Éì„Éº„É´","„Ç±„Éº„Ç≠","„Éâ„Éº„Éä„ÉÑ","„ÇÆ„Çø„Éº"];
const imageMap={ "„ÉÜ„É¨„Éì":"img/tv.png","„Ç≥„É≥„Éî„É•„Éº„Çø„Éº":"img/computer.png","„Éê„Çπ":"img/bus.png","„Éë„É≥":"img/bread.png","„Ç≥„Éº„Éí„Éº":"img/coffee.png","„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†":"img/icecream.png","„Çø„ÇØ„Ç∑„Éº":"img/taxi.png","„Éõ„ÉÜ„É´":"img/hotel.png","„É¨„Çπ„Éà„É©„É≥":"img/restaurant.png","„Çπ„Éû„Éõ":"img/phone.png","„Éì„Éá„Ç™":"img/video.png","„ÉÅ„Éß„Ç≥„É¨„Éº„Éà":"img/chocolate.png","„Éì„Éº„É´":"img/beer.png","„Ç±„Éº„Ç≠":"img/cake.png","„Éâ„Éº„Éä„ÉÑ":"img/donut.png","„ÇÆ„Çø„Éº":"img/guitar.png"};
const romajiMap = {"„Ç¢":"a","„Ç§":"i","„Ç¶":"u","„Ç®":"e","„Ç™":"o","„Ç´":"ka","„Ç≠":"ki","„ÇØ":"ku","„Ç±":"ke","„Ç≥":"ko","„Çµ":"sa","„Ç∑":"shi","„Çπ":"su","„Çª":"se","„ÇΩ":"so","„Çø":"ta","„ÉÅ":"chi","„ÉÑ":"tsu","„ÉÜ":"te","„Éà":"to","„Éä":"na","„Éã":"ni","„Éå":"nu","„Éç":"ne","„Éé":"no","„Éè":"ha","„Éí":"hi","„Éï":"fu","„Éò":"he","„Éõ":"ho","„Éû":"ma","„Éü":"mi","„É†":"mu","„É°":"me","„É¢":"mo","„É§":"ya","„É¶":"yu","„É®":"yo","„É©":"ra","„É™":"ri","„É´":"ru","„É¨":"re","„É≠":"ro","„ÉØ":"wa","„É≤":"wo","„É≥":"n","„Ç¨":"ga","„ÇÆ":"gi","„Ç∞":"gu","„Ç≤":"ge","„Ç¥":"go","„Ç∂":"za","„Ç∏":"ji","„Ç∫":"zu","„Çº":"ze","„Çæ":"zo","„ÉÄ":"da","„ÉÇ":"ji","„ÉÖ":"zu","„Éá":"de","„Éâ":"do","„Éê":"ba","„Éì":"bi","„Éñ":"bu","„Éô":"be","„Éú":"bo","„Éë":"pa","„Éî":"pi","„Éó":"pu","„Éö":"pe","„Éù":"po","„É£":"~ya","„É•":"~yu","„Éß":"~yo","„Éº":"„Éº"};

let usedLevels=[]; let currentWord=""; let correctOrder=[];

/* Drag state */
let activeDrag=null;
let dragOffset={x:0,y:0};
let originalParent=null;
let placeholder=null;
let pointerActiveCard=null;
let pointerStart={x:0,y:0,t:0};

/* ---------- Utils ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---------- Level selection ---------- */
function chooseNewWord(){
  if(usedLevels.length===wordList.length) usedLevels=[];
  const options = wordList.filter(w=> !usedLevels.includes(w));
  currentWord = options[Math.floor(Math.random()*options.length)];
  usedLevels.push(currentWord);
  correctOrder = [...currentWord];
}

/* ---------- Reveal helpers ---------- */
function resetRevealBoxes(){
  document.querySelectorAll('.reveal-box').forEach((b,i)=>{
    b.classList.remove('revealed');
    b.style.backgroundImage = 'url("img/question.png")';
    // position quadrants
    const pos = ["0% 0%","100% 0%","0% 100%","100% 100%"];
    b.style.backgroundPosition = pos[i%pos.length];
  });
}
function revealPuzzleImage(src){
  const pos = ["100% 0%","0% 0%","100% 100%","0% 100%"];
  document.querySelectorAll('.reveal-box').forEach((b,i)=>{
    setTimeout(()=>{
      b.classList.add('revealed');
      b.style.backgroundImage = `url("${src}")`;
      b.style.backgroundPosition = pos[i];
      b.style.backgroundSize = '200% 200%';
    }, i*240);
  });
}

/* ---------- Card creation ---------- */
function createCard(kana){
  const c = document.createElement('div');
  c.className = 'card';
  c.dataset.value = kana;
  c.draggable = true;
  c.innerHTML = `<div class="card-inner"><div class="front">${kana}</div><div class="back">${romajiMap[kana]||""}</div></div>`;

  // single-tap flip (safe): small delay to avoid conflict with drag
  c.addEventListener('click', ()=>{
    if(c.dataset.dragging === 'true') return;
    setTimeout(()=>{ if(c.dataset.dragging !== 'true') c.classList.toggle('flipped'); }, 40);
  });

  // native drag fallback for keyboard/desktop (kept for compatibility)
  c.addEventListener('dragstart', ()=> { activeDrag = c; });
  c.addEventListener('dragend', ()=> { activeDrag = null; });

  return c;
}

/* ---------- Generate level ---------- */
function generateLevel(){
  resetRevealBoxes();
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('result').innerText = '';

  chooseNewWord();
  document.getElementById('levelText').innerText = "Level " + usedLevels.length;

  const top = document.getElementById('topRow');
  const bottom = document.getElementById('bottomRow');
  top.innerHTML = ''; bottom.innerHTML = '';

  // create bottom slots (correctOrder length)
  correctOrder.forEach(()=>{ const s=document.createElement('div'); s.className='slot'; bottom.appendChild(s); });

  // prepare letters: correct letters + noise
  const amountTop = correctOrder.length + Math.floor(Math.random()*3) + 2;
  let noise = Object.keys(romajiMap).filter(k => !correctOrder.includes(k));
  shuffle(noise);
  let letters = [...correctOrder, ...noise.slice(0, amountTop - correctOrder.length)];
  shuffle(letters);

  letters.forEach(k => {
    const sl = document.createElement('div');
    sl.className = 'slot';
    sl.appendChild(createCard(k));
    top.appendChild(sl);
  });

  enableSlotEvents(); enableUniversalInput();
}

const wrongSFX = new Audio("audio/wrong.mp3");
wrongSFX.volume = 1.0;   // volume maksimal

let jpVoice = null;
let isSpeaking = false;

// Cari suara Jepang WANITA
function loadJPVoice() {
    const voices = speechSynthesis.getVoices();

    jpVoice = voices.find(v =>
        v.lang.includes("ja") &&
        (v.name.toLowerCase().includes("female") ||
         v.name.includes("Kyoko") ||
         v.name.includes("Google"))
    );

    if (!jpVoice) {
        jpVoice = voices.find(v => v.lang.includes("ja"));
    }
}

speechSynthesis.onvoiceschanged = loadJPVoice;
loadJPVoice();


// Fungsi bicara universal
function say(text, speed = 1.0) {
    // hentikan suara sebelumnya
    speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.voice = jpVoice;
    u.lang = "ja-JP";
    u.rate = speed;    // kecepatan
    u.pitch = 1.0;
    u.volume = 1.0;    // volume besar

    isSpeaking = true;
    speechSynthesis.speak(u);

    u.onend = () => {
        isSpeaking = false;
    };
}


// Tombol suara normal
document.getElementById("soundBtn").addEventListener("click", () => {
    say(currentWord, 1.0);
});

// Tombol suara lambat üê¢
document.getElementById("soundSlow").addEventListener("click", () => {
    say(currentWord, 0.40);
});

/* ---------- Slot native drop (fallback) ---------- */
function enableSlotEvents(){
  document.querySelectorAll('.slot').forEach(slot=>{
    slot.addEventListener('dragover', e => e.preventDefault());
    slot.addEventListener('drop', ()=>{
      if(!activeDrag) return;
      const origin = activeDrag.parentElement;
      const target = slot.firstElementChild;
      if(target) origin.appendChild(target);
      slot.appendChild(activeDrag);
      checkAnswer();
    });
  });
}

/* ---------- Check answer ---------- */
function checkAnswer(){
  const slots = document.querySelectorAll('#bottomRow .slot');
  const cur = [];
  slots.forEach(s => cur.push(s.firstElementChild ? s.firstElementChild.dataset.value : null));
  if(cur.includes(null)){ document.getElementById('result').innerText = ''; return; }
  if(JSON.stringify(cur) === JSON.stringify(correctOrder)){
    document.getElementById('result').innerText = 'BENAR! ‚úîÔ∏è';
    document.getElementById('nextBtn').style.display = 'inline-block';
    const img = imageMap[currentWord]; if(img) revealPuzzleImage(img);
  } else {
    document.getElementById('result').innerText = 'Salah ‚ùå';
    resetRevealBoxes();

    // üîä MAINKAN SFX SALAH
    wrongSFX.currentTime = 0; 
    wrongSFX.play();

    // (Opsional: getarkan HP)
    // navigator.vibrate?.(120);
 
  }
}

/* ================= Pointer drag implementation (robust) ================= */
function enableUniversalInput(){
  // attach pointer handlers to each card
  document.querySelectorAll('.card').forEach(card=>{
    // ensure no duplicate listeners
    card.removeEventListener('pointerdown', onPointerStart);
    card.addEventListener('pointerdown', onPointerStart);
    // prevent default touch actions that may interfere
    card.style.touchAction = 'none';
  });
}

function onPointerStart(e){
  // left button only for mouse
  if(e.pointerType === 'mouse' && e.button !== 0) return;
  const card = e.currentTarget;

  // record start position & pointer id
  pointerStart.x = e.clientX; pointerStart.y = e.clientY; pointerStart.t = Date.now();
  pointerActiveCard = card;
  card._startRect = card.getBoundingClientRect();
  card._pid = e.pointerId;

  try{ card.setPointerCapture?.(e.pointerId); }catch(_){}
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerEnd);

  e.preventDefault();
}

function onPointerMove(e){
  if(!pointerActiveCard) return;
  if(e.pointerId !== pointerActiveCard._pid) return;

  const dx = e.clientX - pointerStart.x;
  const dy = e.clientY - pointerStart.y;
  const dist = Math.hypot(dx, dy);
  const DRAG_THRESHOLD = 8;

  if(dist > DRAG_THRESHOLD && !activeDrag){
    startDrag(pointerActiveCard, e);
  }

  if(activeDrag && activeDrag === pointerActiveCard){
    activeDrag.style.left = (e.clientX - dragOffset.x) + 'px';
    activeDrag.style.top  = (e.clientY - dragOffset.y) + 'px';
  }
}

function startDrag(card, e){
  activeDrag = card;

  // RECT selalu fresh ‚Üí tidak terpengaruh efek flip
  const rect = card.getBoundingClientRect();

  originalParent = card.parentElement;

  dragOffset.x = e.clientX - rect.left;
  dragOffset.y = e.clientY - rect.top;

  card.dataset.dragging = 'true';
  card.classList.add('dragging');
  card._savedTransform = card.style.transform;
  card.style.transform = "translateZ(0) scale(1) rotateY(0deg)";
  card.style.backfaceVisibility = "hidden";
  card.style.willChange = "left, top, transform";

  // placeholder FIX (menggunakan ukuran REAL kartu)
  placeholder = document.createElement('div');
  placeholder.className = 'slot-placeholder';
  placeholder.style.width = rect.width + 'px';
  placeholder.style.height = rect.height + 'px';
  originalParent.replaceChild(placeholder, card);
  card._placeholder = placeholder;

  // pindah ke body supaya tidak terpotong container
  document.body.appendChild(card);
  card.style.position = 'fixed';
  card.style.left = rect.left + 'px';
  card.style.top = rect.top + 'px';
  card.style.width = rect.width + 'px';
  card.style.height = rect.height + 'px';
  card.style.zIndex = 9999;
  card.style.pointerEvents = 'none';
}

function onPointerEnd(e){
  window.removeEventListener('pointermove', onPointerMove);
  window.removeEventListener('pointerup', onPointerEnd);

  // jika tidak sedang drag ‚Üí berarti tap flip
if(!activeDrag){
    const dx = e.clientX - pointerStart.x;
    const dy = e.clientY - pointerStart.y;
    const dist = Math.hypot(dx, dy);

    if(dist < TAP_THRESHOLD){
        let card = e.target;
        while(card && !card.classList?.contains('card')) card = card.parentElement;
        if(card){
            card.classList.toggle('flipped');
        }
    }

    pointerActiveCard = null;
    return;
}

  // sedang drag ‚Üí finalize drop
  const card = activeDrag;
  const x = e.clientX, y = e.clientY;
  let el = document.elementFromPoint(x,y);

  let targetSlot = el;
  while(targetSlot && !targetSlot.classList?.contains('slot'))
    targetSlot = targetSlot.parentElement;

  if(targetSlot){
    const existing = targetSlot.firstElementChild;

    if(existing){
      // PERFECT SWAP FIX
      targetSlot.replaceChild(card, existing);

      if(card._placeholder && card._placeholder.parentElement){
        card._placeholder.parentElement.replaceChild(existing, card._placeholder);
      } else {
        originalParent.appendChild(existing);
      }
    } else {
      // place normally
      targetSlot.appendChild(card);
      if(card._placeholder && card._placeholder.parentElement)
        card._placeholder.remove();
    }
  } else {
    // return to origin
    if(card._placeholder && card._placeholder.parentElement)
      card._placeholder.parentElement.replaceChild(card, card._placeholder);
    else
      originalParent.appendChild(card);
  }

  // reset style untuk hilangkan efek "terbang setengah"
  card.style.position='';
  card.style.left='';
  card.style.top='';
  card.style.width='';
  card.style.height='';
  card.style.zIndex='';
  card.style.pointerEvents='';

  card.dataset.dragging='false';
  card.classList.remove('dragging');
  card._placeholder = null;

  activeDrag = null;
  placeholder = null;
  originalParent = null;
  pointerActiveCard = null;

// kembalikan transform supaya flip normal lagi
if(card._savedTransform !== undefined){
    card.style.transform = card._savedTransform;
    delete card._savedTransform;
}

if(card._savedTransform !== undefined){
    card.style.transform = card._savedTransform;
    card.style.backfaceVisibility = "";
    card.style.willChange = "";
}

  checkAnswer();
}

/* ---------- Next / Back ---------- */
document.getElementById('nextBtn').addEventListener('click', ()=> generateLevel());
document.getElementById('backBtn').addEventListener('click', ()=> history.back());

/* ---------- Init ---------- */
window.addEventListener('load', ()=> { generateLevel(); });

</script>
</body>
</html>
